import React, { useEffect, useState, useRef } from 'react';
import {
  Box, Table, TableBody, TableCell, TableContainer, TableHead,
  TableRow, Paper, Checkbox, FormControl, InputLabel,
  Select, MenuItem, LinearProgress, Typography,
  Radio, FormControlLabel, Stack, TextField, Alert, Card, Button
} from '@mui/material';

import { useLocation } from 'react-router-dom';
import { doc, getDoc } from 'firebase/firestore';
import { db } from '../firebase';

import { fetchStudentsFromFirestore } from '../pages/ThanhPhan/fetchStudents';
import { enrichStudents } from '../pages/ThanhPhan/enrichStudents';
import { saveRegistrationChanges } from '../pages/ThanhPhan/saveRegistration';
import { saveMultipleDiemDanh } from '../pages/ThanhPhan/saveDiemDanh';
import { saveSingleDiemDanh } from '../pages/ThanhPhan/saveSingleDiemDanh';
import { MySort } from '../utils/MySort';

export default function Lop3() {
  const location = useLocation();
  const useNewVersion = location.state?.useNewVersion ?? false;

  const [students, setStudents] = useState([]);
  const [originalRegistered, setOriginalRegistered] = useState({});
  const [selectedClass, setSelectedClass] = useState('');
  const [classList, setClassList] = useState([]);
  const [namHoc, setNamHoc] = useState(null);
  
  const [isLoading, setIsLoading] = useState(false);
  const [expandedRowId, setExpandedRowId] = useState(null);
  const [viewMode, setViewMode] = useState('bantru');
  const saveTimeout = useRef(null);
  const filteredStudents = students;
  const [lastSaved, setLastSaved] = useState(null);
  const [isSaving, setIsSaving] = useState(false);
  const [saveStatus, setSaveStatus] = useState(null);
  const [showSavedAlert, setShowSavedAlert] = useState(false);
  const [lastSavedTime, setLastSavedTime] = useState(null);

  const today = new Date().toISOString().split('T')[0];

  const [checkAllDiemDanh, setCheckAllDiemDanh] = useState(true);
  const [checkAllBanTru, setCheckAllBanTru] = useState(true);

  useEffect(() => {
    setExpandedRowId(null);
  }, [viewMode]);

  useEffect(() => {
    const allRegistered = students.length > 0 &&
      students.every(s => !s.showRegisterCheckbox || s.registered);
    setCheckAllBanTru(allRegistered); // c·∫≠p nh·∫≠t tr·∫°ng th√°i checkbox theo d·ªØ li·ªáu m·ªõi
  }, [students]);

  useEffect(() => {
    if (lastSaved && !isSaving) {
      // So s√°nh n·∫øu th·ªùi gian m·ªõi kh√°c v·ªõi tr∆∞·ªõc ƒë√≥
      const newTime = lastSaved.getTime();
      if (newTime !== lastSavedTime) {
        setLastSavedTime(newTime);
        setShowSavedAlert(true);

        const timer = setTimeout(() => {
          setShowSavedAlert(false);
        }, 2000); // 5 gi√¢y

        return () => clearTimeout(timer);
      }
    }
  }, [lastSaved, isSaving]);

  useEffect(() => {
    const fetchNamHoc = async () => {
      try {
        const docSnap = await getDoc(doc(db, 'YEAR', 'NAMHOC'));
        if (docSnap.exists()) {
          setNamHoc(docSnap.data().value || 'UNKNOWN');
        }
      } catch (err) {
        console.error('L·ªói khi t·∫£i nƒÉm h·ªçc:', err.message);
        setNamHoc('UNKNOWN');
      }
    };
    fetchNamHoc();
  }, []);

  useEffect(() => {
    const fetchClassList = async () => {
      if (!namHoc) return;
      try {
        const docRef = doc(db, `DANHSACH_${namHoc}`, 'K3');
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          const list = data.list || [];
          setClassList(list);
          if (list.length > 0) setSelectedClass(list[0]);
        }
      } catch (err) {
        console.error('L·ªói khi t·∫£i danh s√°ch l·ªõp:', err.message);
      }
    };
    fetchClassList();
  }, [namHoc]);

  useEffect(() => {
  const fetchData = async () => {
    if (!namHoc || !selectedClass) return;
    setIsLoading(true);
    try {
      const col = `BANTRU_${namHoc}`;
      const raw = await fetchStudentsFromFirestore(col, selectedClass, useNewVersion);
      const enriched = enrichStudents(raw, today, selectedClass, useNewVersion);

      const sorted = MySort(enriched); // ‚úÖ S·∫ÆP X·∫æP SAU KHI enrich

      setStudents(sorted);

      const initMap = {};
      sorted.forEach(s => (initMap[s.id] = s.registered));
      setOriginalRegistered(initMap);
    } catch (err) {
      console.error('L·ªói khi t·∫£i h·ªçc sinh:', err.message);
    } finally {
      setIsLoading(false);
    }
  };
  fetchData();
}, [namHoc, selectedClass]);


  const handleSave = async () => {
    if (!namHoc) return;
    setIsSaving(true);

    const changed = students.filter(s => s.registered !== originalRegistered[s.id]);
    const absent = students.filter(s => !s.diemDanh);

    try {
      await saveRegistrationChanges(changed, namHoc);
      await saveMultipleDiemDanh(absent, namHoc, today);

      const updatedMap = { ...originalRegistered };
      changed.forEach(s => (updatedMap[s.id] = s.registered));
      setOriginalRegistered(updatedMap);

      setLastSaved(new Date()); // üëà TH√äM D√íNG N√ÄY
    } catch (err) {
      console.error('L·ªói khi l∆∞u:', err.message);
    } finally {
      setIsSaving(false);
    }
  };


  const toggleDiemDanh = async (index) => {
    const updated = [...students];
    updated[index].diemDanh = !updated[index].diemDanh;

    if (updated[index].diemDanh) {
      updated[index].vangCoPhep = '';
      updated[index].lyDo = '';
      setExpandedRowId(null);
    } else {
      updated[index].registered = false;
      setExpandedRowId(updated[index].id);

      // ‚úÖ G·ªåI L∆ØU B√ÅN TR√ö NGAY L√öC ƒê√ì
      await saveRegistrationChanges([updated[index]], namHoc);

      // ‚úÖ C·∫¨P NH·∫¨T B·∫¢N SAO C·ª¶A originalRegistered CH·ªà V·ªöI H·ªåC SINH ƒê√ì
      setOriginalRegistered(prev => ({
        ...prev,
        [updated[index].id]: false,
      }));
    }

    setStudents(updated);

    // ‚úÖ ƒêi·ªÉm danh lu√¥n l∆∞u nh∆∞ c≈©
    await saveSingleDiemDanh(updated[index], namHoc);
  };

  const toggleRegister = (index) => {
    const updated = [...students];
    updated[index].registered = !updated[index].registered;
    setStudents(updated);
    clearTimeout(saveTimeout.current);
    saveTimeout.current = setTimeout(handleSave, 2000);
  };

  const handleClassChange = async (event) => {
    clearTimeout(saveTimeout.current);
    await handleSave();
    setSelectedClass(event.target.value);
  };

  const handleVangCoPhepChange = (index, value) => {
    const updated = [...students];
    updated[index].vangCoPhep = value;
    setStudents(updated);
    clearTimeout(saveTimeout.current);
    saveTimeout.current = setTimeout(() => {
      saveSingleDiemDanh(updated[index], namHoc);
    }, 1000);
  };

  const handleLyDoChange = (index, value) => {
    const updated = [...students];
    updated[index].lyDo = value;
    setStudents(updated);

    // G·ªçi l∆∞u sau khi c·∫≠p nh·∫≠t l√Ω do
    clearTimeout(saveTimeout.current);
    saveTimeout.current = setTimeout(() => {
      saveSingleDiemDanh(updated[index], namHoc);
    }, 500); // debounce tr√°nh l∆∞u qu√° nhanh khi ng∆∞·ªùi d√πng ƒëang g√µ
  };

  const handleSendZalo = (student) => {
    const msg = `H·ªçc sinh: ${student.hoVaTen}\nV·∫Øng: ${student.vangCoPhep || '[ch∆∞a ch·ªçn]'}\nL√Ω do: ${student.lyDo || '[ch∆∞a nh·∫≠p]'}`;
    navigator.clipboard.writeText(msg).then(() => alert('ƒê√£ sao ch√©p tin nh·∫Øn. D√°n v√†o Zalo ƒë·ªÉ g·ª≠i.'));
  };

  return (
  <Box sx={{ display: 'flex', justifyContent: 'center', mt: 12 }}>
    <Card
      sx={{
        p: { xs: 2, sm: 3, md: 4 },
        maxWidth: 470,
        width: '100%',
        borderRadius: 4,
        boxShadow: '0 8px 30px rgba(0,0,0,0.15)',
        backgroundColor: 'white',
        minHeight: '100vh'
      }}
      elevation={10}
    >
      <Typography
        variant="h5"
        align="center"
        gutterBottom
        fontWeight="bold"
        color="primary"
        sx={{ mb: 4, borderBottom: '3px solid #1976d2', pb: 1 }}
      >
        DANH S√ÅCH H·ªåC SINH
      </Typography>

      <Box sx={{ display: 'flex', justifyContent: 'center', mt: 1 }}>
        <FormControl size="small" sx={{ width: 120 }}>
          <InputLabel>L·ªõp</InputLabel>
          <Select value={selectedClass} label="L·ªõp" onChange={handleClassChange}>
            {classList.map(cls => (
              <MenuItem key={cls} value={cls}>{cls}</MenuItem>
            ))}
          </Select>
        </FormControl>
      </Box>

      <Stack direction="row" spacing={2} justifyContent="center" sx={{ mt: 1, mb: 2 }}>
        <FormControlLabel
          value="diemdanh"
          control={<Radio checked={viewMode === 'diemdanh'} onChange={() => setViewMode('diemdanh')} />}
          label="ƒêi·ªÉm danh"
        />
        <FormControlLabel
          value="bantru"
          control={<Radio checked={viewMode === 'bantru'} onChange={() => setViewMode('bantru')} />}
          label="B√°n tr√∫"
        />
      </Stack>

      {/* T√≥m t·∫Øt h·ªçc sinh v·∫Øng */}
      {viewMode !== 'bantru' && (
        <Box sx={{ mb: 2, p: 2, backgroundColor: '#f1f8e9', borderRadius: 2 }}>
          <Typography variant="subtitle1" fontWeight="bold" gutterBottom>
            Th√¥ng tin t√≥m t·∫Øt
          </Typography>
          <Stack direction="row" spacing={4} sx={{ pl: 2 }}>
            <Typography variant="body2">
              Sƒ© s·ªë: <strong>{students.length}</strong>
            </Typography>
            <Typography variant="body2">
              V·∫Øng: Ph√©p: <strong>{students.filter(s => !s.diemDanh && s.vangCoPhep === 'c√≥ ph√©p').length}</strong>
              &nbsp;&nbsp;
              Kh√¥ng: <strong>{students.filter(s => !s.diemDanh && s.vangCoPhep === 'kh√¥ng ph√©p').length}</strong>
            </Typography>
          </Stack>

          <Typography variant="subtitle1" fontWeight="bold" sx={{ mt: 2 }}>
            Danh s√°ch h·ªçc sinh v·∫Øng:
          </Typography>
          <Box sx={{ pl: 2 }}>
            {students.filter(s => !s.diemDanh).length === 0 ? (
              <Typography variant="body2">Kh√¥ng c√≥ h·ªçc sinh v·∫Øng.</Typography>
            ) : (
              <Box component="ul" sx={{ pl: 2, mt: 0.5 }}>
                {students.filter(s => !s.diemDanh).map((s, i) => (
                  <li key={s.id}>{s.hoVaTen || 'Kh√¥ng t√™n'} ({s.vangCoPhep === 'c√≥ ph√©p' ? 'P' : 'K'})</li>
                ))}
              </Box>
            )}
          </Box>
        </Box>
      )}

      {isLoading ? (
        <Box sx={{ display: 'flex', justifyContent: 'center' }}>
          <LinearProgress sx={{ width: '50%' }} />
        </Box>
      ) : (
        <TableContainer component={Paper} sx={{ borderRadius: 1, mt: 2 }}>
          <Table size="small" stickyHeader>
            <TableHead>
              <TableRow>
                <TableCell
                  align="center"
                  sx={{
                    fontWeight: 'bold',
                    backgroundColor: '#1976d2',
                    color: 'white',
                    px: { xs: 1, sm: 2 },
                    width: { xs: 30, sm: 'auto' },
                  }}
                >
                  STT
                </TableCell>

                <TableCell
                  align="center"
                  sx={{
                    fontWeight: 'bold',
                    backgroundColor: '#1976d2',
                    color: 'white',
                  }}
                >
                  H·ªå V√Ä T√äN
                </TableCell>

                {viewMode === 'diemdanh' && (
                  <TableCell
                    align="center"
                    sx={{
                      fontWeight: 'bold',
                      backgroundColor: '#1976d2',
                      color: 'white',
                      px: { xs: 1, sm: 2 },
                      width: { xs: 55, sm: 'auto' },
                    }}
                  >
                    ƒêI·ªÇM{"\n"}DANH
                  </TableCell>
                )}

                {viewMode === 'bantru' && (
                  <TableCell
                    align="center"
                    sx={{
                      fontWeight: 'bold',
                      backgroundColor: '#1976d2',
                      color: 'white',
                      px: { xs: 0.5, sm: 2 },
                      width: { xs: 55, sm: 'auto' },
                      whiteSpace: { xs: 'pre-wrap', sm: 'nowrap' },
                    }}
                  >
                    <Stack direction="row" alignItems="center" justifyContent="center" spacing={1}>
                      <Typography sx={{ color: 'white', fontWeight: 'bold' }}>B√ÅN{"\n"}TR√ö</Typography>
                      <Checkbox
                        checked={checkAllBanTru}
                        onChange={async (e) => {
                          const newVal = e.target.checked;
                          setCheckAllBanTru(newVal);

                          // üîÑ C·∫≠p nh·∫≠t danh s√°ch h·ªçc sinh
                          const updated = students.map((s) =>
                            s.showRegisterCheckbox ? { ...s, registered: newVal } : s
                          );
                          setStudents(updated);

                          // üîç L·ªçc nh·ªØng h·ªçc sinh c√≥ registered thay ƒë·ªïi so v·ªõi original
                          const changed = updated.filter(
                            (s) => s.showRegisterCheckbox && s.registered !== originalRegistered[s.id]
                          );

                          // üíæ G·ªçi l∆∞u n·∫øu c√≥ thay ƒë·ªïi
                          if (changed.length > 0) {
                            try {
                              await saveRegistrationChanges(changed, namHoc);

                              // C·∫≠p nh·∫≠t l·∫°i originalRegistered
                              const updatedMap = { ...originalRegistered };
                              changed.forEach((s) => {
                                updatedMap[s.id] = s.registered;
                              });
                              setOriginalRegistered(updatedMap);
                              setLastSaved(new Date());
                            } catch (err) {
                              console.error('L·ªói khi l∆∞u ƒëƒÉng k√Ω b√°n tr√∫:', err.message);
                            }
                          }
                        }}
                        size="small"
                        color="default"
                        sx={{
                          p: 0,
                          color: 'white',
                          '& .MuiSvgIcon-root': { fontSize: 18 },
                        }}
                      />
                    </Stack>
                  </TableCell>
                )}
              </TableRow>
            </TableHead>

              <TableBody>
                {students.map((s, index) => (
                  <React.Fragment key={s.id}>
                    <TableRow>
                      <TableCell
                        align="center"
                        sx={{ px: { xs: 1, sm: 2 }, width: { xs: 30, sm: 'auto' } }}
                      >
                        {index + 1}
                      </TableCell>

                      <TableCell
                        align="left"
                        sx={{
                          px: { xs: 1, sm: 2 },
                          width: { xs: 200, sm: 'auto' },
                          maxWidth: { xs: 200, sm: 'none' },
                        }}
                      >
                        <Typography
                          sx={{
                            cursor: !s.diemDanh ? 'pointer' : 'default',
                            color: '#000000',
                            '&:hover': !s.diemDanh ? { textDecoration: 'underline' } : undefined,
                            whiteSpace: 'nowrap',
                            overflowX: 'auto',
                            WebkitOverflowScrolling: 'touch',
                          }}
                          onClick={() => {
                            if (!s.diemDanh) {
                              setExpandedRowId(prev => (prev === s.id ? null : s.id));
                            }
                          }}
                        >
                          {s.hoVaTen || 'Kh√¥ng c√≥ t√™n'}
                        </Typography>
                      </TableCell>

                      {viewMode === 'diemdanh' && (
                        <TableCell
                          align="center"
                          sx={{ px: { xs: 1, sm: 2 }, width: { xs: 40, sm: 'auto' } }}
                        >
                          <Checkbox
                            checked={s.diemDanh}
                            onChange={() => toggleDiemDanh(index)}
                            size="small"
                            color="primary"
                          />
                        </TableCell>
                      )}

                      {viewMode === 'bantru' && (
                        <TableCell
                          align="center"
                          sx={{ px: { xs: 1, sm: 2 }, width: { xs: 50, sm: 'auto' } }}
                        >
                          {s.showRegisterCheckbox && (
                            <Checkbox
                              checked={s.registered ?? false}
                              onChange={() => toggleRegister(index)}
                              size="small"
                              color="primary"
                            />
                          )}
                        </TableCell>
                      )}
                    </TableRow>

                    {!s.diemDanh && expandedRowId === s.id && (
                      <TableRow>
                        <TableCell
                          colSpan={viewMode === 'bantru' ? 4 : 3}
                          sx={{ backgroundColor: '#f9f9f9' }}
                        >
                          <Stack spacing={1} sx={{ pl: 2, py: 1 }}>
                            <Stack direction="row" spacing={4}>
                              <FormControlLabel
                                control={
                                  <Radio
                                    checked={s.vangCoPhep === 'c√≥ ph√©p'}
                                    onChange={() => handleVangCoPhepChange(index, 'c√≥ ph√©p')}
                                    value="c√≥ ph√©p"
                                    color="primary"
                                    size="small"
                                  />
                                }
                                label="C√≥ ph√©p"
                              />
                              <FormControlLabel
                                control={
                                  <Radio
                                    checked={s.vangCoPhep === 'kh√¥ng ph√©p'}
                                    onChange={() => handleVangCoPhepChange(index, 'kh√¥ng ph√©p')}
                                    value="kh√¥ng ph√©p"
                                    color="primary"
                                    size="small"
                                  />
                                }
                                label="Kh√¥ng ph√©p"
                              />
                            </Stack>

                            <Stack direction="row" spacing={2} alignItems="center">
                              <TextField
                                label="L√Ω do"
                                value={s.lyDo || ''}
                                onChange={(e) => handleLyDoChange(index, e.target.value)}
                                size="small"
                                sx={{ flex: 1 }}
                              />
                              <Button
                                variant="outlined"
                                color="primary"
                                onClick={() => handleSendZalo(s)}
                                size="small"
                                sx={{
                                  whiteSpace: 'nowrap',
                                  px: 2.5,
                                  height: '40px',
                                  backgroundColor: '#e3f2fd',
                                  '&:hover': {
                                    backgroundColor: '#bbdefb',
                                  },
                                }}
                              >
                                Xu·∫•t Zalo
                              </Button>
                            </Stack>
                          </Stack>
                        </TableCell>
                      </TableRow>
                    )}
                  </React.Fragment>
                ))}
              </TableBody>
            </Table>
          </TableContainer>

        )}

        {/* Th√¥ng b√°o l∆∞u */}
        <Box sx={{ mt: 2 }}>
          {isSaving && (
            <Alert severity="info" sx={{ fontSize: '0.875rem' }}>
              ƒêang l∆∞u...
            </Alert>
          )}
          {lastSaved && !isSaving && showSavedAlert && (
            <Alert severity="success" sx={{ fontSize: '0.875rem' }}>
              ƒê√£ l∆∞u l√∫c {lastSaved.toLocaleTimeString('vi-VN')}
            </Alert>
          )}
        </Box>
      </Card>
    </Box>
  );
}